name: Smart Contract Deployment

on:
  workflow_dispatch:
    inputs:
      network:
        description: "Target network for deployment"
        required: true
        default: "devnet"
        type: choice
        options:
          - devnet
          - testnet
          - mainnet
      action:
        description: "Deployment action"
        required: true
        default: "deploy"
        type: choice
        options:
          - deploy
          - verify
          - rollback

env:
  RUST_TOOLCHAIN: 1.89.0
  CARGO_TERM_COLOR: always

jobs:
  validate:
    name: Validate Deployment
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Validate branch
        run: |
          BRANCH=$(git rev-parse --abbrev-ref HEAD)
          echo "Current branch: $BRANCH"

          # Mainnet requires main branch
          if [ "${{ github.event.inputs.network }}" = "mainnet" ]; then
            if [ "$BRANCH" != "main" ]; then
              echo "Error: Mainnet deployments only allowed from main branch"
              exit 1
            fi
          fi

      - name: Check commit status
        run: |
          # Verify working tree is clean
          if ! git diff-index --quiet HEAD --; then
            echo "Error: Working tree has uncommitted changes"
            exit 1
          fi

  tests:
    name: Pre-Deployment Tests
    runs-on: ubuntu-latest
    needs: validate
    timeout-minutes: 30

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: actions-rs/toolchain@v1
        with:
          toolchain: ${{ env.RUST_TOOLCHAIN }}
          override: true

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: "programs/opinion-market"

      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "npm"

      - name: Install dependencies
        run: npm install

      - name: Run tests
        run: npm test
        env:
          RUST_LOG: info

      - name: Build smart contract
        run: cargo build --release
        working-directory: programs/opinion-market

  deploy:
    name: Deploy to ${{ github.event.inputs.network }}
    runs-on: ubuntu-latest
    needs: tests
    if: github.event.inputs.action == 'deploy'
    environment:
      name: ${{ github.event.inputs.network }}
    timeout-minutes: 20

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: actions-rs/toolchain@v1
        with:
          toolchain: ${{ env.RUST_TOOLCHAIN }}
          override: true

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: "programs/opinion-market"

      - name: Build smart contract
        run: cargo build --release
        working-directory: programs/opinion-market

      - name: Set deployment environment
        id: env
        run: |
          case "${{ github.event.inputs.network }}" in
            devnet)
              echo "RPC_URL=https://api.devnet.solana.com" >> $GITHUB_OUTPUT
              echo "CLUSTER=devnet" >> $GITHUB_OUTPUT
              ;;
            testnet)
              echo "RPC_URL=https://api.testnet.solana.com" >> $GITHUB_OUTPUT
              echo "CLUSTER=testnet" >> $GITHUB_OUTPUT
              ;;
            mainnet)
              echo "RPC_URL=https://api.mainnet-beta.solana.com" >> $GITHUB_OUTPUT
              echo "CLUSTER=mainnet-beta" >> $GITHUB_OUTPUT
              ;;
          esac

      - name: Configure Solana CLI
        run: solana config set --url ${{ steps.env.outputs.RPC_URL }}

      - name: Validate keypair
        env:
          SOLANA_KEYPAIR: ${{ secrets[format('{0}_DEPLOYER_KEY', github.event.inputs.network | upper)] }}
        run: |
          if [ -z "$SOLANA_KEYPAIR" ]; then
            echo "Error: Deployment keypair not configured for ${{ github.event.inputs.network }}"
            exit 1
          fi
          echo "$SOLANA_KEYPAIR" > /tmp/deployer.json
          solana address -k /tmp/deployer.json

      - name: Check balance
        run: solana balance -k /tmp/deployer.json

      - name: Deploy program
        run: |
          echo "Deployment to ${{ github.event.inputs.network }} would be executed here"
          echo "Command: anchor deploy --provider.cluster ${{ steps.env.outputs.CLUSTER }}"
          # Actual deployment would happen here with:
          # anchor deploy --provider.cluster ${{ steps.env.outputs.CLUSTER }}
        env:
          ANCHOR_WALLET: /tmp/deployer.json
          ANCHOR_PROVIDER_URL: ${{ steps.env.outputs.RPC_URL }}

      - name: Verify deployment
        run: |
          echo "Verifying deployment to ${{ github.event.inputs.network }}"
          PROGRAM_ID="2NaUpg4jEZVGDBmmuKYLdsAfSGKwHxjghhfgVpQvZJYu"
          solana program show $PROGRAM_ID

      - name: Post deployment summary
        if: success()
        run: |
          echo "✅ Successfully deployed to ${{ github.event.inputs.network }}"
          echo "Program ID: 2NaUpg4jEZVGDBmmuKYLdsAfSGKwHxjghhfgVpQvZJYu"

      - name: Notify on failure
        if: failure()
        run: |
          echo "❌ Deployment to ${{ github.event.inputs.network }} failed"
          exit 1

  verify:
    name: Verify Deployment
    runs-on: ubuntu-latest
    needs: deploy
    if: github.event.inputs.action == 'verify'
    timeout-minutes: 10

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set deployment environment
        id: env
        run: |
          case "${{ github.event.inputs.network }}" in
            devnet)
              echo "RPC_URL=https://api.devnet.solana.com" >> $GITHUB_OUTPUT
              ;;
            testnet)
              echo "RPC_URL=https://api.testnet.solana.com" >> $GITHUB_OUTPUT
              ;;
            mainnet)
              echo "RPC_URL=https://api.mainnet-beta.solana.com" >> $GITHUB_OUTPUT
              ;;
          esac

      - name: Verify program deployment
        run: |
          solana config set --url ${{ steps.env.outputs.RPC_URL }}
          PROGRAM_ID="2NaUpg4jEZVGDBmmuKYLdsAfSGKwHxjghhfgVpQvZJYu"
          echo "Checking program: $PROGRAM_ID"
          solana program show $PROGRAM_ID
          echo "✅ Program verified on ${{ github.event.inputs.network }}"
